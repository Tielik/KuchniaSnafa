{% extends "base.html" %}
{% block title %}Kuchnia Snafa{% endblock %}
{% block content %}
<h1 class="logo">Kuchnia Snafa</h1><br>
<div class="row seven-cols">
    <div class="col-md-1">
        <button type="button" class="btn-kat btn btn-primary" id="kat-zbozowe" onClick="katChange('kat-zbozowe')"
            data-bs-toggle="collapse" data-bs-target="#zbozowe">Produkty zbożowe
        </button>
        <div class="collapse multi-collapse div-kat" id="zbozowe">
            {% if Skladnikiz %}
            {% for x in Skladnikiz %}
            {% if x.kategoria == 1 %}
            <button type="button" class="btn-prod btn btn-light" id="zbozowe{{x}}"
                onClick="wybierzSkladnik('{{x.id}}', '{{x.Nazwa}}')">{{x.Nazwa}}
            </button>

            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    <div class="col-md-1">
        <button type="button" class="btn-kat btn btn-primary" id="kat-warzywa" onClick="katChange('kat-warzywa')"
            data-bs-toggle="collapse" data-bs-target="#warzywa">Warzywa
        </button>
        <div class="collapse multi-collapse div-kat" id="warzywa">
            {% if Skladnikiz %}
            {% for x in Skladnikiz %}
            {% if x.kategoria == 2 %}
            <button type="button" class="btn-prod btn btn-light"
                onClick="wybierzSkladnik('{{x.id}}', '{{x.Nazwa}}')">{{x.Nazwa}}
            </button>

            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    <div class="col-md-1">
        <button type="button" class="btn-kat btn btn-primary" id="kat-owoce" onClick="katChange('kat-owoce')"
            data-bs-toggle="collapse" data-bs-target="#owoce">Owoce
        </button>
        <div class="collapse multi-collapse div-kat" id="owoce">
            {% if Skladnikiz %}
            {% for x in Skladnikiz %}
            {% if x.kategoria == 3 %}
            <button type="button" class="btn-prod btn btn-light"
                onClick="wybierzSkladnik('{{x.id}}', '{{x.Nazwa}}')">{{x.Nazwa}}
            </button>
            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    <div class="col-md-1">
        <button type="button" class="btn-kat btn btn-primary" id="kat-mleczne" onClick="katChange('kat-mleczne')"
            data-bs-toggle="collapse" data-bs-target="#mleczne">Mleko i
            produkty mleczne
        </button>
        <div class="collapse multi-collapse div-kat" id="mleczne">
            {% if Skladnikiz %}
            {% for x in Skladnikiz %}
            {% if x.kategoria == 4 %}
            <button type="button" class="btn-prod btn btn-light"
                onClick="wybierzSkladnik('{{x.id}}', '{{x.Nazwa}}')">{{x.Nazwa}}
            </button>

            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    <div class="col-md-1">
        <button type="button" class="btn-kat btn btn-primary" id="kat-zwierzece" onClick="katChange('kat-zwierzece')"
            data-bs-toggle="collapse" data-bs-target="#zwierzece">Produkty
            pochodzenia zwierzęcego
        </button>
        <div class="collapse multi-collapse div-kat" id="zwierzece">
            {% if Skladnikiz %}
            {% for x in Skladnikiz %}
            {% if x.kategoria == 5 %}
            <button type="button" class="btn-prod btn btn-light"
                onClick="wybierzSkladnik('{{x.id}}', '{{x.Nazwa}}')">{{x.Nazwa}}
            </button>
            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    <div class="col-md-1">
        <button type="button" class="btn-kat btn btn-primary" id="kat-tluszcze" onClick="katChange('kat-tluszcze')"
            data-bs-toggle="collapse" data-bs-target="#tluszcze">Tłuszcze
        </button>
        <div class="collapse multi-collapse div-kat" id="tluszcze">
            {% if Skladnikiz %}
            {% for x in Skladnikiz %}
            {% if x.kategoria == 6 %}
            <button type="button" class="btn-prod btn btn-light"
                onClick="wybierzSkladnik('{{x.id}}', '{{x.Nazwa}}')">{{x.Nazwa}}
            </button>

            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    <div class="col-md-1">
        <button type="button" class="btn-kat btn btn-primary" id="kat-przyprawy" onClick="katChange('kat-przyprawy')"
            data-bs-toggle="collapse" data-bs-target="#przyprawy">Przyprawy
        </button>
        <div class="collapse multi-collapse div-kat" id="przyprawy">
            {% if Skladnikiz %}
            {% for x in Skladnikiz %}
            {% if x.kategoria == 7 %}
            <button type="button" class="btn-prod btn btn-light"
                onClick="wybierzSkladnik('{{x.id}}', '{{x.Nazwa}}')">{{x.Nazwa}}
            </button>

            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    <br>
    <h1 class="twojeSkladniki mb-2 mt-3">Twoje Składniki</h1>
    <form method="POST">
        <div class="current-field row"></div>
        {% if form!=null %}
            <div class="previous-field row">
                {% for x in SkladnikiWybrane %}
                <div class="col-sm-3 py-2">
                    <div class="py-4" id="{{x.id}}">
                        {{x.Nazwa}}
                        <input style="display:none;" type="text" name="{{x.id}}" value="{{x.id}}">
                        <button type="button" class="btn-end float-end btn btn-danger"
                            onClick="deleteP('{{x.id}}')">Usuń</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <button type="submit" class="btn-gotowe btn btn-primary mb-2">Gotowe</button>
    </form>

    {% if dania %}
    <div class="ms-1 mt-3 row row-cols-1 row-cols-md-4">
        {% for danias in dania %}
        <div class="col mb-4">
            <div class="card h-100 dish-card">
                {%set var=danias.id|string %}
                <img src="{{url_for('static', filename='img/'+var+'.png')}}" class="card-img-top" alt="...">
                <div class="card-body">
                    <h5 class="card-title">{{danias.nazwa}}</h5>
                    <p class="card-text">{{danias.opis}}</p>
                    <a href="/danie/{{danias.id}}" class="btn btn-primary">Przejdź do przepisu</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{%endif%}
<script>
    let wybrane = [];
    let x = "";
    //if skladnikiwybrane is not null
    //for each x in skladnikiwybrane
    //add them to wybrane so they cant be repeated
    {% if SkladnikiWybrane %}
    {%for x in SkladnikiWybrane %}
    x += {{ x.id }}+" ";
    {% endfor %}
    {% endif %}
    let array = x.split(" ");
    wybrane = array;
    console.log(wybrane);
    let btnGotowe = document.querySelector(".btn-gotowe");
    btnGotowe.style.display = "none";
    let currentField = document.querySelector(".current-field");
    let previousField = document.querySelector(".previous-field.row");
    let twojeSkladniki = document.querySelector(".twojeSkladniki");
    if (currentField.innerHTML.trim().length == 0 && previousField.innerHTML.trim().length == 0)
        twojeSkladniki.style.display = "none";
    else
        twojeSkladniki.style.display = "block";

// This function is responsible for selecting a product and adding it to the list of selected products.
// 
// Parameters:
// - idProduktu: The ID of the product to be selected.
// - nazwaProduktu: The name of the product to be selected.
//
// Returns:
// - false: If the product is already selected.
// - if not false: the product is successfully added to the list of selected products.
//   and displed for user
    function wybierzSkladnik(idProduktu, nazwaProduktu) {
        if (wybrane.includes(idProduktu)) {
            return false;
        }
        else {
            twojeSkladniki.style.display = "block";
            wybrane.push(idProduktu);
            btnGotowe.style.display = "block";

            let nazwa = document.createElement("label");
            nazwa.setAttribute("id", "nazwaProduktu");
            nazwa.setAttribute("for", idProduktu);
            nazwa.innerHTML = nazwaProduktu;

            let ID = document.createElement("input");
            ID.setAttribute("type", "text");
            ID.setAttribute("id", idProduktu);
            ID.setAttribute("name", idProduktu);
            ID.setAttribute("style", "display:none;");

            let btnUsun = document.createElement("button");
            btnUsun.setAttribute("type", "button");
            btnUsun.setAttribute("class", "btn-end float-end btn btn-danger");
            btnUsun.innerHTML = "Usuń";
            console.log(wybrane);
            btnUsun.onclick = () => {
                currentField.removeChild(poleMain);
                wybrane.splice(wybrane.indexOf(idProduktu), 1);
                if (currentField.innerHTML.trim().length == 0) {
                    twojeSkladniki.style.display = "none";
                }
            }

            let pole = document.createElement("div");
            pole.setAttribute("class", "py-4");
            pole.append(nazwa);
            pole.append(ID);
            pole.append(btnUsun);

            let poleMain = document.createElement("div");
            poleMain.setAttribute("class", "col-sm-3 py-2");
            poleMain.append(pole);

            currentField.append(poleMain);
        }
    }
// Deletes a product from the list of selected products.
// 
// Parameters:
// - produktid: The ID of the product to be deleted.
// 
// Returns:
// - None
    function deleteP(produktid) {
        console.log(produktid);
        const index = wybrane.indexOf((produktid).toString());
        console.log(index);
        const x = wybrane.splice(index, 1);
        let pDoUsuniecia = document.getElementById(produktid);
        pDoUsuniecia.remove();
        if (previousField.innerHTML.trim().length == 0) {
            twojeSkladniki.style.display = "none";
        }
        btnGotowe.style.display = "none";
        btnGotowe.click();
    }
// Toggles the "kat-clicked" class on the button element with the given ID
// in order to obtain the appearance of smooth single block with buttons
// with the btn-prod class below.
// 
// Parameters:
// - kat: The ID of the button element to toggle the class on.
// 
// Returns:
// - None
    function katChange(kat) {
        const btnKat = document.getElementById(kat);
        isClicked = btnKat.getAttribute("aria-expanded");
        if (isClicked == "true")
            btnKat.classList.add("kat-clicked");
        else if (isClicked == "false")
            btnKat.classList.remove("kat-clicked");
    }
</script>
{% endblock %}